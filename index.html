<!-- ê¸°ì¡´ ì½”ë“œ ìƒëµ -->
<button onclick="convertAddress()">ë³€í™˜í•˜ê¸°</button>
<button onclick="toggleRaw()" id="toggleRawBtn" style="display:none;">ê²€ìƒ‰ê²°ê³¼í˜•ì‹ë³´ê¸°</button>
<button onclick="toggleDetail()" id="toggleDetailBtn" style="display:none;">ìƒì„¸ë³´ê¸°</button>

<div class="result" id="result"></div>
<div class="raw" id="rawResult" style="display:none;"></div>

<!-- ğŸ”½ ìƒì„¸ë³´ê¸° ê²°ê³¼ ì˜ì—­ -->
<div id="detailBox" style="display:none; margin-top: 1em; background: white; border-radius: 8px; padding: 1em;">
  <button onclick="toggleDetail()" style="float:right;">âŒ</button>
  <h3>ìƒì„¸ ì£¼ì†Œ ì •ë³´</h3>
  <div id="detailContent"></div>
</div>

<script>
  let lastRaw = null;

  function checkSearchedWord(value) {
    const sqlWords = ["OR", "SELECT", "INSERT", "DELETE", "UPDATE", "CREATE", "DROP", "EXEC", "UNION", "FETCH", "DECLARE", "TRUNCATE"];
    const specialChars = /[%=><]/;
    if (specialChars.test(value)) return false;
    return !sqlWords.some(word => new RegExp(`\\b${word}\\b`, "i").test(value));
  }

  function toggleRaw() {
    const rawDiv = document.getElementById("rawResult");
    const btn = document.getElementById("toggleRawBtn");
    if (rawDiv.style.display === "none") {
      rawDiv.style.display = "block";
      btn.innerText = "ìˆ¨ê¸°ê¸°";
      rawDiv.innerText = JSON.stringify(lastRaw, null, 2);
    } else {
      rawDiv.style.display = "none";
      btn.innerText = "ê²€ìƒ‰ê²°ê³¼í˜•ì‹ë³´ê¸°";
    }
  }

  function toggleDetail() {
    const detailBox = document.getElementById("detailBox");
    const btn = document.getElementById("toggleDetailBtn");
    if (detailBox.style.display === "none") {
      const j = lastRaw.raw || {};
      const detailHTML = `
        <table>
          <tr><td>ë„ë¡œëª…ì£¼ì†Œ</td><td><input value="${j.roadAddr || ''}" /></td>
              <td>ê³µë™ì£¼íƒì—¬ë¶€</td><td><input value="${j.bdKdcd || ''}" /></td></tr>
          <tr><td>ì§€ë²ˆ ì£¼ì†Œ</td><td><input value="${j.jibunAddr || ''}" /></td>
              <td>ì‹œë„ëª…</td><td><input value="${j.siNm || ''}" /></td></tr>
          <tr><td>ìš°í¸ë²ˆí˜¸</td><td><input value="${j.zipNo || ''}" /></td>
              <td>ì‹œêµ°êµ¬ëª…</td><td><input value="${j.sggNm || ''}" /></td></tr>
          <tr><td>í–‰ì •êµ¬ì—­ì½”ë“œ</td><td><input value="${j.admCd || ''}" /></td>
              <td>ìë©´ë™ëª…</td><td><input value="${j.emdNm || ''}" /></td></tr>
          <tr><td>ë„ë¡œëª…ì½”ë“œ</td><td><input value="${j.rnMgtSn || ''}" /></td>
              <td>ë²•ì •ë¦¬ëª…</td><td><input value="${j.liNm || ''}" /></td></tr>
          <tr><td>ì‚°ì—¬ë¶€</td><td><input value="${j.mtYn || ''}" /></td>
              <td>ë„ë¡œëª…</td><td><input value="${j.rn || ''}" /></td></tr>
          <tr><td>ë„ë¡œëª…ì£¼ì†Œ(í•œê¸€)</td><td colspan="3"><input style="width: 100%;" value="${j.korAddr || ''}" /></td></tr>
          <tr><td>ê±´ë¬¼ë³¸ë²ˆ - ê±´ë¬¼ë¶€ë²ˆ</td><td><input value="${j.buldMnnm || ''}" /></td>
              <td>-</td><td><input value="${j.buldSlno || ''}" /></td></tr>
          <tr><td>ì§€ë²ˆë³¸ë²ˆ - ì§€ë²ˆë¶€ë²ˆ</td><td><input value="${j.lnbrMnnm || ''}" /></td>
              <td>-</td><td><input value="${j.lnbrSlno || ''}" /></td></tr>
        </table>`;
      document.getElementById("detailContent").innerHTML = detailHTML;
      detailBox.style.display = "block";
    } else {
      detailBox.style.display = "none";
    }
  }

  async function convertAddress() {
    const keyword = document.getElementById("addressInput").value.trim();
    const resultDiv = document.getElementById("result");
    document.getElementById("toggleRawBtn").style.display = "none";
    document.getElementById("toggleDetailBtn").style.display = "none";
    document.getElementById("detailBox").style.display = "none";
    resultDiv.innerHTML = "ğŸ”„ ë³€í™˜ ì¤‘...";

    if (!checkSearchedWord(keyword)) {
      resultDiv.innerHTML = '<p class="error">âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ê²€ìƒ‰ì–´ì…ë‹ˆë‹¤.</p>';
      return;
    }

    try {
      const res = await fetch(`/.netlify/functions/convert?keyword=${encodeURIComponent(keyword)}`);
      const data = await res.json();
      lastRaw = data;

      if (data.errorCode && data.errorCode !== "0") {
        resultDiv.innerHTML = `<p class="error">âŒ ì˜¤ë¥˜ (${data.errorCode}): ${data.errorMessage}</p>`;
      } else {
        resultDiv.innerHTML = `
          <p><strong>ì˜ë¬¸ ë„ë¡œëª… ì£¼ì†Œ:</strong> ${data.roadAddr || "ì—†ìŒ"}</p>
          <p><strong>ì˜ë¬¸ ì§€ë²ˆ ì£¼ì†Œ:</strong> ${data.jibunAddr || "ì—†ìŒ"}</p>
          <p><strong>ìš°í¸ë²ˆí˜¸:</strong> ${data.zipNo || "ì—†ìŒ"}</p>
        `;
        document.getElementById("toggleRawBtn").style.display = "inline-block";
        document.getElementById("toggleDetailBtn").style.display = "inline-block";
      }
    } catch (err) {
      console.error(err);
      resultDiv.innerHTML = '<p class="error">âŒ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    }
  }
</script>
